generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = "postgresql://postgres.wgdxgzraacfhfbxvxuzy:@Kinantiku1@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"
  directUrl = "postgresql://postgres.wgdxgzraacfhfbxvxuzy:@Kinantiku1@aws-0-ap-southeast-1.pooler.supabase.com:5432/postgres?pgbouncer=true&connection_limit=1"
}
model User {
  id        Int    @id @default(autoincrement()) 
  nama      String
  phone     String  @unique // Nomor WhatsApp
  password  String @default("")
  role      Role  
  kelas     Kelas?
  guruTugas Assignment[] @relation("GuruTugas") 
  tugas     AssignmentStatus[] // Menyimpan status tugas siswa
  submissions AssignmentSubmission[] // Relasi ke tugas yang dikumpulkan siswa
}

model Assignment {
  id          Int      @id @default(autoincrement()) 
  kode        String   @unique 
  guru        User     @relation("GuruTugas", fields: [guruId], references: [id]) 
  guruId      Int
  kelas       String  
  judul       String
  deskripsi   String
  pdfUrl      String?  // Bisa null jika guru tidak melampirkan PDF
  lampirkanPDF Boolean @default(false) // Apakah tugas memerlukan PDF?
  createdAt   DateTime @default(now()) 
  deadline    DateTime? // Kolom baru untuk menyimpan deadline (opsional)
  status      AssignmentStatus[] // Relasi ke status tugas siswa
  submissions AssignmentSubmission[] // Relasi ke tugas yang dikumpulkan siswa
  kunciJawaban String? // Kunci jawaban untuk tugas (opsional)
}

// Model untuk menyimpan status tugas siswa (apakah selesai atau belum)
model AssignmentStatus {
  id        Int      @id @default(autoincrement())
  siswa     User     @relation(fields: [siswaId], references: [id])
  siswaId   Int
  tugas    Assignment @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  tugasId   Int
  status    TugasStatus @default(BELUM_SELESAI)
}

// Model baru untuk menyimpan tugas yang dikumpulkan siswa
model AssignmentSubmission {
  id        Int      @id @default(autoincrement())
  siswa     User     @relation(fields: [siswaId], references: [id])
  siswaId   Int
  tugas    Assignment @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  tugasId   Int
  pdfUrl    String?  // Bisa null jika tidak ada lampiran
  status    TugasStatus @default(SELESAI) // Status tugas (opsional)
  createdAt DateTime @default(now()) 
  updatedAt  DateTime @updatedAt
  evaluation String? // Feedback atau evaluasi dari guru/AI (opsional)
  grade     String?  // Nilai tugas (opsional)
  score    Int?   // Skor tugas (opsional)
}

enum Role {
  guru
  siswa
}

enum Kelas {
  XTKJ1
  XTKJ2
  XITKJ1
  XITKJ2
  XIITKJ1
  XIITKJ2
  TPTUP
}

enum TugasStatus {
  BELUM_SELESAI
  SELESAI
}

model ConversationState {
  id         String   @id @default(cuid())
  userPhone  String   @unique
  lastIntent String?
  slots      Json
  updatedAt  DateTime @updatedAt
}

model NlpLog {
  id         String   @id @default(cuid())
  userPhone  String
  text       String
  predicted  String
  confidence Float
  entities   Json?
  createdAt  DateTime @default(now())
}


// =================== ENUM ===================
enum AssessmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
}

enum MediaType {
  IMAGE
  AUDIO
  PDF
  OTHER
}

// =================== INTI PENILAIAN ===================
model Assessment {
  id          Int        @id @default(autoincrement())
  guruId      Int
  code        String     @unique
  title       String
  className   String

  // --- kolom di bawah ini bikin error karena tidak ada di DB kamu.
  // --- tandai @ignore agar Prisma tidak mengikutkannya saat query/insert.
  description String?    @ignore
  kkm         Int?       @ignore
  status      String?    @ignore
  timeOpen    DateTime?  @ignore
  timeClose   DateTime?  @ignore
  durationMin Int?       @ignore
  shuffleQuestions     Boolean? @ignore
  shuffleOptions       Boolean? @ignore
  maxAttempts          Int?     @ignore
  showScoreImmediately Boolean? @ignore
  showKeyAfterClose    Boolean? @ignore

  questions   Question[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Question {
  id           Int        @id @default(autoincrement())
  assessmentId Int
  data         Json       // ‚Üê seluruh isi soal (teks, opsi, kunci, url gambar)
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
}

// =================== PHONE TO JID MAPPING ===================
// Menyimpan mapping nomor telepon ke WhatsApp JID
// Diperlukan untuk handle @lid (Linked ID) pada device yang di-link
model PhoneJidMapping {
  id        Int      @id @default(autoincrement())
  phone     String   @unique  // Nomor telepon (62xxx)
  jid       String             // WhatsApp JID (xxx@c.us atau xxx@lid)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================== CHAT ACTIVITY LOG ===================
// Menyimpan log aktivitas chat untuk monitoring
model ChatActivity {
  id        Int      @id @default(autoincrement())
  phone     String   // Nomor telepon yang chat
  jid       String   // WhatsApp JID
  role      String?  // Role user (guru/siswa/unknown)
  message   String?  // Sample pesan (opsional, untuk debugging)
  createdAt DateTime @default(now())
  
  @@index([phone])
  @@index([createdAt])
}



